<?xml version="1.0"?>

<robot xmlns:xacro="http://wiki.ros.org/xacro">

    <xacro:include filename="$(find kr20_kr120)/urdf/kr120_macro.xacro"/>
    
    <xacro:macro name="kr120_pinza" params="parent">

        <xacro:kuka_kr120_r2700 name="kr120_pinza_connector" origin_xyz="0 0 0" origin_rpy="0 0 1.5708" mass="1" ixx="0.1" ixy="0" ixz="0" iyy="0.1" iyz="0" izz="0.1" file_dae="package://kr20_kr120/visual/kr120_slider.dae" file_stl="package://kr20_kr120/collision/kr120_slider.stl" scale="0.001 0.001 0.001"/>
    
        <xacro:kuka_kr120_r2700 name="kr120_pinza_left" origin_xyz="0 0 0" origin_rpy="0 0 1.5708" mass="1" ixx="0.1" ixy="0" ixz="0" iyy="0.1" iyz="0" izz="0.1" file_dae="package://kr20_kr120/visual/kr120_pinza_left.dae" file_stl="package://kr20_kr120/collision/kr120_pinza_left.stl" scale="0.001 0.001 0.001"/>

        <xacro:kuka_kr120_r2700 name="kr120_pinza_right" origin_xyz="0 0 0" origin_rpy="0 0 1.5708" mass="1" ixx="0.1" ixy="0" ixz="0" iyy="0.1" iyz="0" izz="0.1" file_dae="package://kr20_kr120/visual/kr120_pinza_right.dae" file_stl="package://kr20_kr120/collision/kr120_pinza_right.stl" scale="0.001 0.001 0.001"/>

        <xacro:kuka_kr120_r2700 name="kr120_gyro_left" origin_xyz="-0.597 0 0" origin_rpy="0 0 1.5708" mass="1" ixx="0.1" ixy="0" ixz="0" iyy="0.1" iyz="0" izz="0.1" file_dae="package://kr20_kr120/visual/kr120_gyro_left.dae" file_stl="package://kr20_kr120/collision/kr120_gyro_left.stl" scale="0.001 0.001 0.001"/>

        <xacro:kuka_kr120_r2700 name="kr120_gyro_right" origin_xyz="-0.597 0 0" origin_rpy="0 0 1.5708" mass="1" ixx="0.1" ixy="0" ixz="0" iyy="0.1" iyz="0" izz="0.1" file_dae="package://kr20_kr120/visual/kr120_gyro_right.dae" file_stl="package://kr20_kr120/collision/kr120_gyro_right.stl" scale="0.001 0.001 0.001"/>

        <xacro:kuka_kr120_r2700_joint name="kr120_pinza_connector_joint" type="fixed"
                parent="${parent}" child="kr120_pinza_connector" axis="0 0 1"
                limit_l="0" limit_u="0" limit_v="0" limit_e="0"
                origin_xyz="0 0 0" origin_rpy="0 0 0" 
                damping="0" friction="0" />
        
        <joint name="kr120_pinza_left_joint" type="prismatic">
            <parent link="kr120_pinza_connector"/>
            <child link="kr120_pinza_left"/>
            <axis xyz="0 1 0"/>
            <limit lower="0" upper="0.0355" velocity="0.5" effort="500"/>
            <origin xyz="0 0 0" rpy="0 0 0"/>
            <dynamics damping="0" friction="0" />
        </joint>

        <joint name="kr120_pinza_right_joint" type="prismatic">
            <parent link="kr120_pinza_connector"/>
            <child link="kr120_pinza_right"/>
            <axis xyz="0 1 0"/>
            <limit lower="-0.0355" upper="0" velocity="0.5" effort="500"/>
            <origin xyz="0 0 0" rpy="0 0 0"/>
            <dynamics damping="0" friction="0" />
            <!-- <mimic joint="pinza_left_joint" multiplier="-1.0" offset="0" /> -->
        </joint>

        <xacro:kuka_kr120_r2700_joint name="kr120_gyro_left_joint" type="revolute"
                parent="kr120_pinza_left" child="kr120_gyro_left" axis="0 1 0"
                limit_l="-3.1415" limit_u="3.1415" limit_v="4.53786" limit_e="1000"
                origin_xyz="0.597 0 0" origin_rpy="0 0 0"
                damping="0" friction="0"/>

        <joint name="kr120_gyro_right_joint" type="revolute">
            <parent link="kr120_pinza_right"/>
            <child link="kr120_gyro_right"/>
            <axis xyz="0 -1 0"/>
            <limit lower="-3.1415" upper="3.1415" velocity="4.53786" effort="1000"/>
            <origin xyz="0.597 0 0" rpy="0 0 0" />
            <dynamics damping="0" friction="0" />
            <!-- <mimic joint="gyro_left_joint" multiplier="-1.0" offset="0"/> -->
        </joint>

        <xacro:kuka_kr120_r2700_transmission name="kr120_trans_pinza_left_joint"
                            joint_name="kr120_pinza_left_joint"
                            actuator_name="kr120_motor_pinza_left_joint" />

        <xacro:kuka_kr120_r2700_transmission name="kr120_trans_pinza_right_joint"
                            joint_name="kr120_pinza_right_joint"
                            actuator_name="kr120_motor_pinza_right_joint" />
        
        <xacro:kuka_kr120_r2700_transmission name="kr120_trans_gyro_left_joint"
                            joint_name="kr120_gyro_left_joint"
                            actuator_name="kr120_motor_gyro_left_joint" />

        <xacro:kuka_kr120_r2700_transmission name="kr120_trans_gyro_right_joint"
                            joint_name="kr120_gyro_right_joint"
                            actuator_name="kr120_motor_gyro_right_joint" />

        <!-- <xacro:macro name="mimic_joint_plugin_gazebo" params="parent_joint mimic_joint has_pid:=false multiplier:=-1.0 offset:=0 sensitiveness:=0.0 max_effort:=200 robot_namespace:='/kr120r2700'">
                <gazebo>
                    <plugin name="${mimic_joint}_mimic_joint_plugin" filename="libroboticsgroup_upatras_gazebo_mimic_joint_plugin.so">
                        <joint>${parent_joint}</joint>
                        <mimicJoint>${mimic_joint}</mimicJoint>
                        <xacro:if value="${has_pid}">
                            <hasPID />
                        </xacro:if>
                        <multiplier>${multiplier}</multiplier>
                        <offset>${offset}</offset>
                        <sensitiveness>${sensitiveness}</sensitiveness>
                        <maxEffort>${max_effort}</maxEffort>
                        <xacro:unless value="${robot_namespace == '/kr120r2700'}">
                            <robotNamespace>($robot_namespace)</robotNamespace>
                        </xacro:unless>
                    </plugin>
                </gazebo>
        </xacro:macro>

        <xacro:mimic_joint_plugin_gazebo  parent_joint="pinza_right_joint" mimic_joint="pinza_left_joint" 
                                                has_pid="true" multiplier="-1.0" max_effort="200" />

        <xacro:mimic_joint_plugin_gazebo parent_joint="gyro_right_joint" mimic_joint="gyro_left_joint"
                                                has_pid="true" multiplier="-1.0" max_effort="200" />  -->
        
         <gazebo>
                <plugin name="gazebo_grasp_fix" filename="libgazebo_grasp_fix.so">
                    <arm>
                        <arm_name>kr120_pinza</arm_name>
                        <palm_link>kr120_pinza_right</palm_link>
                        <palm_link>kr120_pinza_left</palm_link>
                        <gripper_link>kr120_gyro_left</gripper_link>
                        <gripper_link>kr120_gyro_right</gripper_link>
                    </arm>
                    <!-- <forces_angle_tolerance>100</forces_angle_tolerance> -->
                    <update_rate>50</update_rate>
                    <grip_count_threshold>4</grip_count_threshold>
                    <max_grip_count>25</max_grip_count>
                    <release_tolerance>0.0045</release_tolerance>
                    <disable_collision_on_attach>true</disable_collision_on_attach>
                    <contact_topic>__default_topic__</contact_topic>
                </plugin>
        </gazebo> 
</xacro:macro>
</robot>

        
        
    